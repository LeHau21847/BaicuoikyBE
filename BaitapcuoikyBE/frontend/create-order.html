<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t H√†ng</title>
    <link rel="stylesheet" href="style.css">
    <script src="main.js"></script>
</head>
<body>
    <div id="navbar"></div>
    <script>
        fetch("nav.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;
            });
    </script>
    <div class="container">
        <div class="header">
            <h2>Trang Mua H√†ng</h2>
            <div>
                <a href="my-orders.html" class="checkout-btn" style="text-decoration:none; background:#17a2b8; font-size:14px; padding: 8px 15px;">üìú L·ªãch S·ª≠ ƒê∆°n</a>
                <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div class="grid-layout">
            <div class="card">
                <h3>Danh S√°ch S·∫£n Ph·∫©m</h3>
                <div id="productList">ƒêang t·∫£i...</div>
            </div>

            <div class="card cart-panel">
                <h3>Gi·ªè H√†ng C·ªßa B·∫°n</h3>
                <ul id="cartList" style="list-style: none; padding: 0;"></ul>
                
                <div class="total-section" style="margin-top: 20px; font-weight: bold; font-size: 1.2em;">
                    T·ªïng ti·ªÅn: <span id="totalPrice" style="color: red;">0</span> ƒë
                </div>
                
                <button class="checkout-btn" onclick="submitOrder()">X√°c Nh·∫≠n ƒê·∫∑t H√†ng</button>
            </div>
        </div>
    </div>

    <script>
    let cart = []; // Bi·∫øn l∆∞u gi·ªè h√†ng t·∫°m

    // 1. T·∫£i danh s√°ch s·∫£n ph·∫©m
    async function loadProducts() {
        const res = await apiGet("/products");
        if (!res.ok) { logout(); return; }
        
        const list = await res.json();
        const div = document.getElementById("productList");
        div.innerHTML = "";

        list.forEach(p => {
            div.innerHTML += `
                <div class="product-item" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                    <div>
                        <strong>${p.name}</strong><br>
                        Gi√°: ${p.price.toLocaleString()} ƒë - Kho: ${p.stock}
                    </div>
                    <button onclick="addToCart(${p.id}, '${p.name}', ${p.price})" style="padding:5px 10px;">Th√™m</button>
                </div>
            `;
        });
    }

    // 2. Th√™m v√†o gi·ªè
    function addToCart(id, name, price) {
        const existing = cart.find(x => x.productId === id);
        if (existing) {
            existing.quantity++;
        } else {
            cart.push({ productId: id, name: name, price: price, quantity: 1 });
        }
        renderCart();
    }

    // 3. V·∫Ω l·∫°i gi·ªè h√†ng
    function renderCart() {
        const ul = document.getElementById("cartList");
        ul.innerHTML = "";
        let total = 0;

        cart.forEach((item, index) => {
            total += item.price * item.quantity;
            ul.innerHTML += `
                <li style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dashed #eee; padding-bottom:5px;">
                    <span>${item.name} (x${item.quantity})</span>
                    <span class="remove-item" onclick="removeFromCart(${index})" style="cursor:pointer; color:red; font-weight:bold;">‚ùå</span>
                </li>
            `;
        });

        document.getElementById("totalPrice").innerText = total.toLocaleString();
    }

    // 4. X√≥a kh·ªèi gi·ªè
    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // 5. G·ª≠i ƒë∆°n h√†ng (ƒê√£ s·ª≠a logic l·∫•y UserID)
    async function submitOrder() {
        if (cart.length === 0) {
            alert("Gi·ªè h√†ng ƒëang tr·ªëng!");
            return;
        }

        // L·∫•y UserID t·ª´ localStorage (h√†m n√†y trong main.js)
        const userId = getUserId();
        if (!userId) {
            alert("L·ªói phi√™n ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            logout();
            return;
        }

        // T·∫°o d·ªØ li·ªáu g·ª≠i ƒëi
        const orderData = {
            customerId: userId,
            items: cart.map(c => ({ productId: c.productId, quantity: c.quantity }))
        };

        try {
            const res = await apiPost("/orders", orderData);
            
            if (res.ok) {
                alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
                cart = []; // X√≥a gi·ªè h√†ng
                renderCart();
                loadProducts(); // Load l·∫°i ƒë·ªÉ th·∫•y kho b·ªã tr·ª´
            } else {
                const err = await res.text();
                // Hi·ªÉn th·ªã l·ªói chi ti·∫øt t·ª´ Backend
                alert("L·ªói ƒë·∫∑t h√†ng: " + err);
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi Server! Vui l√≤ng th·ª≠ l·∫°i.");
        }
    }

    loadProducts();
    </script>
</body>
</html>