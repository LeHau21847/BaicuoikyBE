<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n L√Ω S·∫£n Ph·∫©m</title>
    <link rel="stylesheet" href="style.css">
    <script src="main.js"></script>
</head>
<body>
    <div id="navbar"></div>
    <script>
        fetch("nav.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar").innerHTML = html;
            });
    </script>
    <div class="container">
        <div class="header">
            <h2>Qu·∫£n L√Ω S·∫£n Ph·∫©m (Admin)</h2>
            <div>
                <a href="customers.html" class="checkout-btn" style="text-decoration:none; background:#17a2b8; font-size:14px; padding: 8px 15px;">üë• Kh√°ch H√†ng</a>
                <a href="admin-orders.html" class="checkout-btn" style="text-decoration:none; background:#ffc107; color:black; font-size:14px; padding: 8px 15px;">üìã ƒê∆°n H√†ng</a>
                <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div class="card">
            <h3 id="formTitle">Th√™m S·∫£n Ph·∫©m M·ªõi</h3>
            <input type="hidden" id="pId">

            <div class="input-row">
                <input id="pName" placeholder="T√™n s·∫£n ph·∫©m">
                <input id="pPrice" type="number" placeholder="Gi√° ti·ªÅn">
                <input id="pStock" type="number" placeholder="S·ªë l∆∞·ª£ng">
                <input id="pDesc" placeholder="M√¥ t·∫£">
            </div>
            <div style="margin-top: 10px;">
                <button id="btnSave" onclick="saveProduct()">L∆∞u S·∫£n Ph·∫©m</button>
                <button id="btnCancel" onclick="cancelEdit()" style="background: #6c757d; display: none;">H·ªßy B·ªè</button>
            </div>
        </div>

        <h3>Danh S√°ch S·∫£n Ph·∫©m</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n</th>
                    <th>Gi√°</th>
                    <th>T·ªìn kho</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
        </table>
    </div>

    <script>
    // 1. T·∫£i danh s√°ch
    async function loadProducts() {
        const res = await apiGet("/products");
        
        if (!res.ok) {
            if (res.status === 401 || res.status === 403) {
                alert("H·∫øt phi√™n ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng ƒë·ªß quy·ªÅn!");
                logout();
            }
            return;
        }

        const list = await res.json();
        const tbody = document.getElementById("productTableBody");
        tbody.innerHTML = "";

        list.forEach(p => {
            // L∆∞u √Ω: N√∫t S·ª≠a g·ªçi h√†m startEdit v·ªõi ƒë·∫ßy ƒë·ªß tham s·ªë
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.price.toLocaleString()} ƒë</td>
                    <td>${p.stock}</td>
                    <td>
                        <button style="background:#ffc107; color:black" onclick="startEdit(${p.id}, '${p.name}', ${p.price}, ${p.stock}, '${p.description || ''}')">S·ª≠a</button>
                        <button class="delete-btn" onclick="deleteProduct(${p.id})">X√≥a</button>
                    </td>
                </tr>
            `;
        });
    }

    // 2. Chu·∫©n b·ªã Form ƒë·ªÉ s·ª≠a
    function startEdit(id, name, price, stock, desc) {
        document.getElementById("formTitle").innerText = "C·∫≠p Nh·∫≠t S·∫£n Ph·∫©m #" + id;
        document.getElementById("pId").value = id;
        document.getElementById("pName").value = name;
        document.getElementById("pPrice").value = price;
        document.getElementById("pStock").value = stock;
        document.getElementById("pDesc").value = desc;

        document.getElementById("btnSave").innerText = "C·∫≠p Nh·∫≠t";
        document.getElementById("btnCancel").style.display = "inline-block";
        
        // Cu·ªôn l√™n ƒë·∫ßu trang ƒë·ªÉ s·ª≠a cho d·ªÖ
        window.scrollTo(0, 0);
    }

    // 3. H·ªßy s·ª≠a -> Quay v·ªÅ form th√™m m·ªõi
    function cancelEdit() {
        document.getElementById("formTitle").innerText = "Th√™m S·∫£n Ph·∫©m M·ªõi";
        document.getElementById("pId").value = "";
        document.getElementById("pName").value = "";
        document.getElementById("pPrice").value = "";
        document.getElementById("pStock").value = "";
        document.getElementById("pDesc").value = "";

        document.getElementById("btnSave").innerText = "L∆∞u S·∫£n Ph·∫©m";
        document.getElementById("btnCancel").style.display = "none";
    }

    // 4. X·ª≠ l√Ω L∆∞u (Create ho·∫∑c Update)
    async function saveProduct() {
        const id = document.getElementById("pId").value;
        const data = {
            name: document.getElementById("pName").value,
            price: Number(document.getElementById("pPrice").value),
            stock: Number(document.getElementById("pStock").value),
            description: document.getElementById("pDesc").value
        };

        // Validate c∆° b·∫£n
        if(!data.name || data.price < 0 || data.stock < 0) {
            alert("Vui l√≤ng nh·∫≠p ƒë√∫ng th√¥ng tin (Gi√° v√† T·ªìn kho ph·∫£i >= 0)");
            return;
        }

        let res;
        try {
            if (id) {
                // UPDATE (PUT)
                res = await fetch(API_BASE + "/products/" + id, {
                    method: "PUT",
                    headers: { 
                        "Content-Type": "application/json", 
                        "Authorization": "Bearer " + getToken() 
                    },
                    body: JSON.stringify(data)
                });
            } else {
                // CREATE (POST)
                res = await apiPost("/products", data);
            }

            if (res.ok) {
                alert(id ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m m·ªõi th√†nh c√¥ng!");
                cancelEdit();
                loadProducts();
            } else {
                const txt = await res.text();
                alert("L·ªói: " + txt);
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi! H√£y ki·ªÉm tra xem Backend ƒë√£ t·∫Øt WebDAV ch∆∞a.");
        }
    }

    // 5. X√≥a s·∫£n ph·∫©m
    async function deleteProduct(id) {
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) return;
        const res = await apiDelete("/products/" + id);
        if (res.ok) loadProducts();
        else alert("X√≥a th·∫•t b·∫°i!");
    }

    // Ch·∫°y khi m·ªü trang
    loadProducts();
    </script>
</body>
</html>